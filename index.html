<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Upscaler</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo i {
            font-size: 2.5rem;
            color: #ffd700;
        }

        .logo h1 {
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .main-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .upload-section {
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #fafafa;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .upload-content {
            pointer-events: none;
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }

        .upload-content h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #333;
        }

        .upload-content p {
            color: #666;
            font-size: 1.1rem;
        }

        .browse-link {
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
        }

        .supported-formats {
            margin-top: 20px;
            color: #888;
        }

        .settings-section {
            margin-bottom: 30px;
            display: none;
        }

        .settings-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            color: #333;
            font-size: 1.3rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .setting-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.95rem;
        }

        .setting-group select,
        .setting-group input[type="number"] {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .setting-group select:focus,
        .setting-group input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .range-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .range-container input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e1e5e9;
            outline: none;
            -webkit-appearance: none;
        }

        .range-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .range-value {
            font-weight: 600;
            color: #667eea;
            min-width: 60px;
            text-align: center;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .preset-btn {
            padding: 8px 16px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .preset-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .preset-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e1e5e9;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            border-color: #dee2e6;
        }

        .btn-download {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }

        .processing-section {
            text-align: center;
            padding: 60px 20px;
            display: none;
        }

        .processing-content h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .processing-content p {
            color: #666;
            margin-bottom: 30px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            animation: progress 2s ease-in-out infinite;
        }

        @keyframes progress {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }

        .results-section {
            display: none;
        }

        .results-section h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            color: #28a745;
            font-size: 1.3rem;
        }

        .image-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-bottom: 30px;
            align-items: start;
        }

        .image-container {
            text-align: center;
        }

        .image-container h4 {
            margin-bottom: 15px;
            color: #555;
            font-size: 1.1rem;
        }

        .image-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .image-info {
            font-size: 0.9rem;
            color: #666;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .comparison-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 2rem;
            color: #667eea;
        }

        .download-section {
            text-align: center;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #e1e5e9;
        }

        .modal-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #dc3545;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .modal-close:hover {
            background: #f8f9fa;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e1e5e9;
            text-align: right;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .logo h1 {
                font-size: 2rem;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .image-comparison {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .comparison-arrow {
                transform: rotate(90deg);
            }
            
            .action-buttons,
            .download-section {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-expand-arrows-alt"></i>
                <h1>AI Image Upscaler</h1>
            </div>
            <p class="subtitle">Transform your images with advanced AI-powered upscaling</p>
        </header>

        <main class="main-content">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <h3>Drop your image here</h3>
                        <p>or <span class="browse-link">browse files</span></p>
                        <input type="file" id="fileInput" accept="image/*" hidden>
                        <div class="supported-formats">
                            <small>Supported: PNG, JPG, JPEG, BMP, TIFF, WebP (Max 50MB)</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="settings-section" id="settingsSection">
                <h3><i class="fas fa-cog"></i> Upscaling Settings</h3>
                
                <div class="settings-grid">
                    <div class="setting-group">
                        <label for="scaleFactor">Scale Factor</label>
                        <div class="range-container">
                            <input type="range" id="scaleFactor" min="1" max="5" step="0.1" value="2">
                            <span class="range-value" id="scaleFactorValue">2.0x</span>
                        </div>
                        <div class="preset-buttons">
                            <button class="preset-btn" data-scale="1.5">1.5x</button>
                            <button class="preset-btn" data-scale="2">2x</button>
                            <button class="preset-btn" data-scale="3">3x</button>
                            <button class="preset-btn" data-scale="4">4x</button>
                        </div>
                    </div>

                    <div class="setting-group">
                        <label for="interpolation">Algorithm</label>
                        <select id="interpolation">
                            <option value="ai_enhanced">AI Enhanced (Recommended)</option>
                            <option value="lanczos">Lanczos4 (High Quality)</option>
                            <option value="cubic">Cubic (Balanced)</option>
                            <option value="linear">Linear (Fast)</option>
                        </select>
                    </div>

                    <div class="setting-group">
                        <label for="quality">Output Quality</label>
                        <div class="range-container">
                            <input type="range" id="quality" min="1" max="100" value="95">
                            <span class="range-value" id="qualityValue">95%</span>
                        </div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" id="backBtn">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" id="upscaleBtn">
                        <i class="fas fa-magic"></i> Upscale Image
                    </button>
                </div>
            </div>

            <!-- Processing Section -->
            <div class="processing-section" id="processingSection">
                <div class="processing-content">
                    <div class="spinner"></div>
                    <h3>Upscaling your image...</h3>
                    <p>This may take a few moments depending on image size</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <h3><i class="fas fa-check-circle"></i> Upscaling Complete!</h3>
                
                <div class="results-content">
                    <div class="image-comparison">
                        <div class="image-container">
                            <h4>Original</h4>
                            <img id="originalImage" alt="Original image">
                            <div class="image-info" id="originalInfo"></div>
                        </div>
                        <div class="comparison-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="image-container">
                            <h4>Upscaled</h4>
                            <img id="upscaledImage" alt="Upscaled image">
                            <div class="image-info" id="upscaledInfo"></div>
                        </div>
                    </div>

                    <div class="download-section">
                        <button class="btn btn-download" id="downloadBtn">
                            <i class="fas fa-download"></i> Download Upscaled Image
                        </button>
                        <button class="btn btn-secondary" id="newImageBtn">
                            <i class="fas fa-plus"></i> Upscale Another Image
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Error Modal -->
        <div class="modal" id="errorModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
                    <button class="modal-close" id="closeErrorModal">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="errorMessage"></p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" id="closeErrorBtn">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentFile = null;
        let currentFileId = null;

        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const settingsSection = document.getElementById('settingsSection');
        const processingSection = document.getElementById('processingSection');
        const resultsSection = document.getElementById('resultsSection');

        // Settings elements
        const scaleFactor = document.getElementById('scaleFactor');
        const scaleFactorValue = document.getElementById('scaleFactorValue');
        const interpolation = document.getElementById('interpolation');
        const quality = document.getElementById('quality');
        const qualityValue = document.getElementById('qualityValue');

        // Buttons
        const backBtn = document.getElementById('backBtn');
        const upscaleBtn = document.getElementById('upscaleBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const newImageBtn = document.getElementById('newImageBtn');

        // Modal elements
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const closeErrorModal = document.getElementById('closeErrorModal');
        const closeErrorBtn = document.getElementById('closeErrorBtn');

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            initializePresetButtons();
        });

        function initializeEventListeners() {
            // Upload area events
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            // File input change
            fileInput.addEventListener('change', handleFileSelect);
            
            // Range inputs
            scaleFactor.addEventListener('input', updateScaleFactorValue);
            quality.addEventListener('input', updateQualityValue);
            
            // Button events
            backBtn.addEventListener('click', goBack);
            upscaleBtn.addEventListener('click', startUpscaling);
            downloadBtn.addEventListener('click', downloadImage);
            newImageBtn.addEventListener('click', resetApp);
            
            // Modal events
            closeErrorModal.addEventListener('click', hideErrorModal);
            closeErrorBtn.addEventListener('click', hideErrorModal);
            errorModal.addEventListener('click', (e) => {
                if (e.target === errorModal) hideErrorModal();
            });
        }

        function initializePresetButtons() {
            // Scale factor presets
            document.querySelectorAll('.preset-buttons .preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const scale = parseFloat(btn.dataset.scale);
                    scaleFactor.value = scale;
                    updateScaleFactorValue();
                    updatePresetButtons(btn);
                });
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // Validate file type
            const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/bmp', 'image/tiff', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showError('Please select a valid image file (PNG, JPG, JPEG, BMP, TIFF, WebP)');
                return;
            }
            
            // Validate file size (50MB max)
            if (file.size > 50 * 1024 * 1024) {
                showError('File size must be less than 50MB');
                return;
            }
            
            currentFile = file;
            showSettings();
        }

        function showSettings() {
            uploadSection.style.display = 'none';
            settingsSection.style.display = 'block';
            
            // Reset form
            scaleFactor.value = 2;
            interpolation.value = 'ai_enhanced';
            quality.value = 95;
            
            updateScaleFactorValue();
            updateQualityValue();
            updatePresetButtons();
        }

        function updateScaleFactorValue() {
            const value = parseFloat(scaleFactor.value);
            scaleFactorValue.textContent = value.toFixed(1) + 'x';
        }

        function updateQualityValue() {
            const value = parseInt(quality.value);
            qualityValue.textContent = value + '%';
        }

        function updatePresetButtons(activeBtn = null) {
            // Clear all active states
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Set active state
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        function goBack() {
            settingsSection.style.display = 'none';
            uploadSection.style.display = 'block';
            currentFile = null;
            fileInput.value = '';
        }

        function startUpscaling() {
            if (!currentFile) {
                showError('Please select a file first');
                return;
            }
            
            showProcessing();
            uploadFile();
        }

        function showProcessing() {
            settingsSection.style.display = 'none';
            processingSection.style.display = 'block';
            
            // Animate progress bar
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = '100%';
        }

        function uploadFile() {
            const formData = new FormData();
            formData.append('file', currentFile);
            formData.append('scale_factor', scaleFactor.value);
            formData.append('interpolation', interpolation.value);
            formData.append('quality', quality.value);
            
            // Add timeout handling
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
            
            fetch('/api/upload', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    currentFileId = data.file_id;
                    showResults(data);
                } else {
                    showError(data.error || 'Upscaling failed');
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('Error:', error);
                if (error.name === 'AbortError') {
                    showError('Upscaling timed out. Please try with a smaller image or different settings.');
                } else {
                    showError('Network error occurred. Please try again.');
                }
            });
        }

        function showResults(data) {
            processingSection.style.display = 'none';
            resultsSection.style.display = 'block';
            
            // Show original image
            const originalImg = document.getElementById('originalImage');
            const originalInfo = document.getElementById('originalInfo');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                originalImg.src = e.target.result;
                
                // Get image dimensions
                const img = new Image();
                img.onload = function() {
                    originalInfo.textContent = `${img.width} × ${img.height} pixels`;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(currentFile);
            
            // Show upscaled image
            const upscaledImg = document.getElementById('upscaledImage');
            const upscaledInfo = document.getElementById('upscaledInfo');
            
            // Use base64 data directly
            upscaledImg.src = `data:image/png;base64,${data.output_data}`;
            upscaledImg.onload = function() {
                upscaledInfo.textContent = `${this.naturalWidth} × ${this.naturalHeight} pixels`;
            };
            
            // Set download URL
            downloadBtn.onclick = () => {
                // Create download link with base64 data
                const link = document.createElement('a');
                link.href = `data:image/png;base64,${data.output_data}`;
                link.download = `upscaled_${data.file_id}.png`;
                link.click();
            };
        }

        function downloadImage() {
            // This function is now handled in showResults()
            // The download button is set up there with base64 data
        }

        function resetApp() {
            // Reset state
            currentFile = null;
            currentFileId = null;
            fileInput.value = '';
            
            // Show upload section
            resultsSection.style.display = 'none';
            uploadSection.style.display = 'block';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorModal.style.display = 'block';
            
            // Hide processing if showing
            processingSection.style.display = 'none';
            settingsSection.style.display = 'block';
        }

        function hideErrorModal() {
            errorModal.style.display = 'none';
        }
    </script>
</body>
</html>
